%
% Copyright (C) 2018 The LaTeX3 Project
%

\documentclass{minimal}
\input{regression-test}

\RequirePackage[enable-debug]{expl3}
\RequirePackage{l3benchmark}
\ExplSyntaxOn
\debug_on:n { check-declarations , deprecation , log-functions }
\ExplSyntaxOff

\START
\ExplSyntaxOn

\sys_if_timer_exist:F
  {
    \benchmark_once:n \ERROR \TRUE
    \benchmark_once_apply:nN \ERROR \ERROR \TRUE
    \benchmark:n \ERROR \TRUE
    \benchmark_apply:nN \ERROR \ERROR \TRUE
    \END
  }

\int_if_exist:NT \l__benchmark_duration_int
  { \int_set:Nn \l__benchmark_duration_int { 65536 / 10 } }

\OMIT
\cs_new:Npn \test:nn #1#2 { #2 {#1} }
\TIMO

\OMIT
\exp_args:NNx \seq_set_from_clist:Nn \l_tmpa_seq
  { \prg_replicate:nn { 123 } { a , } }
\cs_new_protected:Npn \test_slow_code:
  { \seq_reverse:N \l_tmpa_seq }
\TIMO

\TEST { benchmark_once }
  {
    \int_zero:N \l_tmpa_int
    \benchmark_once_apply:nN { \int_incr:N \l_tmpa_int }
      \test:nn { \fp_set:Nn \l_tmpa_fp }
    \int_log:N \l_tmpa_int    % Check the code was done only once
    \fp_compare:nTF { \l_tmpa_fp < 5e-5 }  % Check it took 0 to 3 scaled seconds
      { \TRUE }
      { \ERROR \fp_show:N \l_tmpa_fp }
  }

\TEST { benchmark }
  {
    \clist_clear:N \l_tmpa_clist
    \clist_clear:N \l_tmpb_clist
    \prg_replicate:nn { 3 }
      {
        \benchmark_apply:nN { \test_slow_code: }
          \test:nn { \clist_put_right:Nn \l_tmpa_clist }
        \benchmark_apply:nN { \test_slow_code: \test_slow_code: }
          \test:nn { \clist_put_right:Nn \l_tmpb_clist }
      }
    \fp_compare:nTF % Check that doing code twice takes between 1.5 and 2.5 times as much
      {
        (1.5 * min ( \l_tmpa_clist ) < max ( \l_tmpb_clist ))
        && (2.5 * max ( \l_tmpa_clist ) > min ( \l_tmpb_clist ))
      }
      { \TRUE }
      {
        \ERROR
        \TYPE { 1:\l_tmpa_clist }
        \TYPE { 2:\l_tmpb_clist }
      }
  }

\END
